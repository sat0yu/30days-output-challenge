一昨日から続いた「RDBにおける木構造の表現方法」シリーズも今回で最後となる。
これまで隣接リスト、閉包テーブルと２つの表現方法をみてきた。
本文では３つめの表現方法として「入れ子集合」を紹介し、長所・短所を探っていきたい。

入れ子集合表現ではこれまでと全く異なる視点を導入する必要がある。
木構造の節点を「点」で考えることから離れ、それぞれの節点を二次元的な大きさを持った「図形」として捉るのだ。
根に近い節点ほど大きな面積をもち、葉に近い節点は小さな面積をもつ。
さらに、節点の親子関係は、ちょうど親が子の図形を内包するようにして表現される。

これまで度々例として登場した木構造は以下の図で表現できる。
Aが根で、Bが節、CとDが葉に相当する。

(          A          )
  (   B   ) (  C  )
   (  D  )

構造情報をRDBに格納するには、各節点の左端・右端の位置を節点情報と一緒に保存すればよい。
上図の場合は以下のようなエントリになるだろう。

e.g. NestedSet
| --- | ------- | ---- | ------ |
| id | name | left | right |
| 1  |  A      |  1   |   8    |
| 2  |  B      |  2   |   5    |
| 3  |  C      |  3   |   4    |
| 4  |  D      |  6   |   7    |

少し見づらいが、対応する括弧に番号を記すと以下のようになる。
(1          A          8)
  (2  B  5) (6 C 7)
   (3 D 4)

それでは、次に入れ子集合におけるデータ操作性をみていこう。
入れ子集合では包含関係をクエリの条件節に用いる。
例えば、葉の節点は他の節点を内部に含まないはずだし、根は逆に他の節点に含まれない。
これらをクエリで表現するとそれぞれ以下のようになる。

e.g. 葉の節点を取得
SELECT * FROM NestedSet AS p WHERE NOT EXISTS (SELECT * FROM NestedSet AS c WHERE p.left > c.left AND c.right < p.right);
e.g. 根の節点を取得（節点を取得する場合のpとcを入れ替えただけ）
SELECT * FROM NestedSet AS c WHERE NOT EXISTS (SELECT * FROM NestedSet AS p WHERE p.left > c.left AND c.right < p.right);

では、特定の節点のすべて子孫を取得するにはどうすればよいだろうか。
図を思い浮かべて包含関係を考えてみるとすぐに答えがわかるだろう。
すなわち、自分よりも内側にある節点をすべて取得するだけで済む。

e.g. Aのすべての子孫を取得
SELECT * FROM NestedSet AS c WHERE 1 < c.left AND c.right < 8;

じつは入れ子集合表現で難しい操作は「自分の子をすべて取得する」タスクだ。
なぜなら、「節点Xの子 ＝ Xとの間に他の節点が存在しない」という条件をSQLで表す必要があるからだ。
具体的には、親と子、そして中間節点を表すために３つの自己結合が必要になる。

歯切れが悪いようだが、クエリが複雑で説明が長くなるため、ここでは抽象的な方法論を述べるにとどめる。
より深く調べる際には下記記事を参照されたい。

SQLで木と階層構造のデータを扱う（１）―― 入れ子集合モデル
http://mickindex.sakura.ne.jp/database/db_tree_ns.html

記事中では節点の追加・削除操作についても言及されている。
いずれも「面積（左端・右端）を広げる（狭める）」操作をクエリで表現することで達成できる。
ただし、追加・削除操作では対象節点の子孫・祖先すべてのレコードを更新する必要があるため、とくに深さが大きい木構造ではパフォーマンス上の問題を考慮する必要が生まれるかもしれない。

以上長くなったが、３日間にわたり３種類の木構造表現方法をみてきた。
直感的な操作が可能な隣接リストから、新しいパラダイムで構造をコンパクトに表現する入れ子集合、そして簡便さと操作性を備えた閉包テーブルまで、それぞれ長所・短所さまざまだ。

話は変わるが、複数人が同じコードベースにふれる実際の開発現場では「分かりやすさ」は非常に大きなファクターである。
洗練された表現方法で得られるパフォーマンスも魅力的だが、とくに組織で開発を進めていく場合には、中長期的な視点もふまえ「分かりやすさ」も考慮に入れたバランスの良い意思決定をしていきたいと思う。
