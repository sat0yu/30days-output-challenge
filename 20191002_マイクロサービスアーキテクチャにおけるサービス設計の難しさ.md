Domain-driven designやクリーンアーキテクチャといった事柄について議論するとき、ソースコードを用いて具体例を表すことができる利点は大きい。
設計について学んだことがある人ならば、おそらくDDDやその類の言葉を目にしてすぐに大まかなコンポーネント構造やディレクトリ構造が頭に浮かぶだろう。
コンポーネントの関係性における規則も、そう難しくなく適当な解、少なくとも方向性を探れると思う。

では、マイクロサービスアーキテクチャにおけるサービス設計の議論を行う場合はどうだろか。
筆者の感覚としては、議論にせよ設計にせよ、サービス単位になった途端に難易度が飛躍的に大きくなると感じている。
コンポーネントの粒度と比較して試行錯誤のコストが非常に大きかったり、境界線・コンテキストが定まりきらないなど、理由はいくつも挙げられるが、ここではとくに「思考の流れが安定性依存に反している」という点を取り上げたい。

一般に安定性依存の原則（Stable Dependencies Principle）によれば、安定性が高いサービス（コンポーネント）に対して低い方が依存する方向が良いとされる。
なぜなら、安定性が高いほど変更の可能性が低く、変更が少ないほど他のサービスに対する影響を抑えることができるからだ。
コンポーネント単位で安定性依存を実現するには、安定性が高いコンポーネントにインタフェースを置き、低い方がインタフェースを満たすように具体的な実装を行えばよい。
このように分離することで、仮に安定性が低いコンポーネントに変更が発生しても、安定性が高いコンポーネントは影響をうけずに済む。

では実際に、複数のコンポーネントを横断しながら新しい機能を実装するときの思考の流れを想像してもらいたい。
例えばある新しい機能Aが必要となったとする。
このとき、まずはじめに自然と意識が向かうのは「アクターXとYをZにして〜」という全体のロジックではないだろうか。その後でようやく具体的な手段「XはDBから取得して〜」を考える。
すなわち、安定性が高い方（ドメインロジック）から低い方（DBやフレームワーク）へと焦点が移っていく。

一方で、マイクロサービスアーキテクチャにおいて機能を開発する状況を想像してもらいたい。
おそらくは機能の外観など外部仕様に相当する部分が起点になるのではないだろうか。
PMとデザイナ、フロントエンドにサーバサイドのエンジニアが集まって会話するには、共通言語としての絵やプロトタイプが非常に有効だ。
そうなると自然と焦点は作業の接合部、すなわちAPI設計に集中する。
誰だってチームのボトルネックにはなりたくない。サーバサイドエンジニアはすぐにモックを作成に取り掛かるかもしれない。

注意しなければいけないのは、（作業接合部の）APIは抽象度（＝安定性）が最も低いという点だ。
それにも関わらず、フロントエンドにしろサーバサイドにしろ、おそらく彼らはこのAPIを作る（使う）ことを起点に思考を始める。
冒頭で「思考の流れが安定性依存に反している」と主張した理由はここある。
「APIのレスポンスでXXXとYYYが必要」だとしても、サーバサイドエンジニアはそれだけを理由にして安定性が高いサービスにAPI起因のロジック実装を要請してはいけない。

もちろん、こういった状況すべてが悪手だと言い切る意図はない。
筆者が主張したいのは、安定性依存の原則、すなわち「抽象（マイクロサービス）が詳細（API）に依存してはならない」という点だ。
理想的には、APIレスポンスの型に固執せずに「マイクロサービスがどのようなメソッドを備えるべきか」という問いに向かい合うべきだ。
将来的にそのメソッドは他の機能開発で再利用することができるだろうか。

以上、マイクロサービスアーキテクチャにおけるサービス設計の難しさについて、筆者の考えを述べた。
おそらくは、チーム全体のコミュニケーションのあり方など、筆者の環境に特有の事情も多分に含まれていると思う。
あくまで一個人の、ある個別のケースで得た経験が元となっていることを忘れないでいただきたい。
